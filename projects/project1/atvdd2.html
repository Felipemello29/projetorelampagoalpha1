<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Previsão do Tempo</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        
        .controls { display: flex; gap: 20px; margin-bottom: 30px; justify-content: center; flex-wrap: wrap; }
        select { padding: 10px; border-radius: 4px; border: 1px solid #ccc; min-width: 200px; font-size: 16px; }
        
        #mensagem-erro { color: white; background-color: #e74c3c; padding: 10px; border-radius: 4px; display: none; margin-bottom: 20px; text-align: center; }
        
        #previsao-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        
        .card-dia { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card-header { background-color: #3498db; color: white; padding: 10px; text-align: center; }
        .card-header h3 { margin: 0; font-size: 1.1em; }
        .card-header span { font-size: 0.9em; opacity: 0.9; }
        
        .periodos { padding: 10px; }
        .periodo-box { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .periodo-box:last-child { border-bottom: none; }
        .periodo-titulo { font-weight: bold; color: #555; margin-bottom: 5px; text-transform: uppercase; font-size: 0.8em; }
        
        .temp-range { font-weight: bold; margin: 5px 0; }
        .temp-min { color: #3498db; }
        .temp-max { color: #e74c3c; }
        
        .resumo { font-size: 0.9em; color: #666; font-style: italic; }
        img.icone-tempo { width: 50px; height: 50px; }

        .loading { text-align: center; color: #666; display: none; }
        .cache-badge { text-align: center; font-size: 0.8em; color: #27ae60; margin-bottom: 10px; display: none;}
    </style>
</head>
<body>

<div class="container">
    <h1>Consultar Previsão do Tempo</h1>
    
    <div id="mensagem-erro"></div>
    <div id="msg-cache" class="cache-badge">Dados carregados da memória (sem gastar internet)</div>

    <div class="controls">
        <select id="select-estado">
            <option value="">Selecione um Estado</option>
        </select>
        <select id="select-cidade" disabled>
            <option value="">Aguardando Estado...</option>
        </select>
    </div>

    <div id="loading" class="loading">Carregando dados...</div>
    <div id="previsao-container"></div>
</div>

<script>
    const selectEstado = document.getElementById('select-estado');
    const selectCidade = document.getElementById('select-cidade');
    const divPrevisao = document.getElementById('previsao-container');
    const divErro = document.getElementById('mensagem-erro');
    const divLoading = document.getElementById('loading');
    const divMsgCache = document.getElementById('msg-cache');

    let timerDebounce = null;
    
    // --- Cache Simples ---
    // Vai guardar: { "2304400": [dados...], "3550308": [dados...] }
    const cachePrevisoes = {}; 

    function mostrarErro(msg) {
        divErro.textContent = msg;
        divErro.style.display = 'block';
        divLoading.style.display = 'none';
        divMsgCache.style.display = 'none';
    }

    function limparErro() {
        divErro.style.display = 'none';
    }

    function obterNomeDiaSemana(dataString) {
        const partes = dataString.split('/');
        const data = new Date(partes[2], partes[1] - 1, partes[0]);
        const dias = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
        return dias[data.getDay()];
    }

    function buscarEstados() {
        return fetch('https://servicodados.ibge.gov.br/api/v1/localidades/estados?orderBy=nome')
            .then(res => res.ok ? res.json() : Promise.reject(res.statusText))
            .then(data => data.map(e => ({ id: e.id, sigla: e.sigla, nome: e.nome })));
    }

    function buscarCidades(ufId) {
        return fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${ufId}/municipios`)
            .then(res => res.ok ? res.json() : Promise.reject(res.statusText))
            .then(data => data.map(c => ({ id: c.id, nome: c.nome })));
    }

    function buscarPrevisao(codigoIbge) {
        // 1. Verifica se já temos estes dados na memória
        if (cachePrevisoes[codigoIbge]) {
            console.log("Usando cache para:", codigoIbge);
            return Promise.resolve({ dados: cachePrevisoes[codigoIbge], fromCache: true });
        }

        // 2. Se não tem, busca na API
        return fetch(`https://apiprevmet3.inmet.gov.br/previsao/${codigoIbge}`)
            .then(response => {
                if (!response.ok) return Promise.reject('Erro INMET: ' + response.statusText);
                return response.json();
            })
            .then(data => {
                const dadosCidade = data[codigoIbge];
                if (!dadosCidade) return Promise.reject('Dados indisponíveis.');

                const diasPrevisao = Object.keys(dadosCidade).map(key => ({
                    data: key,
                    dados: dadosCidade[key]
                })).slice(0, 4);

                // 3. Guarda no Cache antes de devolver
                cachePrevisoes[codigoIbge] = diasPrevisao;
                
                return { dados: diasPrevisao, fromCache: false };
            });
    }

    // Inicialização
    buscarEstados().then(estados => {
        estados.forEach(estado => {
            const opt = document.createElement('option');
            opt.value = estado.sigla; 
            opt.dataset.id = estado.id; 
            opt.textContent = `${estado.nome} (${estado.sigla})`;
            selectEstado.appendChild(opt);
        });
    }).catch(mostrarErro);

    // Evento Estado
    selectEstado.addEventListener('change', function() {
        limparErro();
        divMsgCache.style.display = 'none';
        divPrevisao.innerHTML = '';
        const ufId = this.options[this.selectedIndex].dataset.id;

        if (!ufId) {
            selectCidade.innerHTML = '<option value="">Aguardando Estado...</option>';
            selectCidade.disabled = true;
            return;
        }

        selectCidade.innerHTML = '<option>Carregando...</option>';
        selectCidade.disabled = true;

        buscarCidades(ufId).then(cidades => {
            selectCidade.innerHTML = '<option value="">Selecione a Cidade</option>';
            cidades.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.nome;
                selectCidade.appendChild(opt);
            });
            selectCidade.disabled = false;
        }).catch(mostrarErro);
    });

    // Evento Cidade com DEBOUNCE e CACHE
    selectCidade.addEventListener('change', function() {
        limparErro();
        divMsgCache.style.display = 'none';
        const codigoIbge = this.value;
        if (!codigoIbge) return;

        if (timerDebounce) clearTimeout(timerDebounce);

        // Se já estiver em cache, não esperamos o debounce, mostramos na hora!
        if (cachePrevisoes[codigoIbge]) {
            renderizar(cachePrevisoes[codigoIbge], true);
            return;
        }

        divLoading.style.display = 'block';
        divPrevisao.innerHTML = ''; 

        // Se não está em cache, espera 1.5s para ter certeza que o usuário parou
        timerDebounce = setTimeout(function() {
            buscarPrevisao(codigoIbge)
                .then(resultado => {
                    divLoading.style.display = 'none';
                    renderizar(resultado.dados, resultado.fromCache);
                })
                .catch(mostrarErro);
        }, 1500); // Aumentei para 1.5 segundos para garantir
    });

    function renderizar(listaDias, usouCache) {
        divPrevisao.innerHTML = '';
        divMsgCache.style.display = usouCache ? 'block' : 'none';

        listaDias.forEach(diaInfo => {
            const card = document.createElement('div');
            card.className = 'card-dia';
            card.innerHTML = `<div class="card-header"><h3>${diaInfo.data}</h3><span>${obterNomeDiaSemana(diaInfo.data)}</span></div>`;
            
            const pContainer = document.createElement('div');
            pContainer.className = 'periodos';
            
            ['manha', 'tarde', 'noite'].forEach(p => {
                if (diaInfo.dados[p]) {
                    const d = diaInfo.dados[p];
                    pContainer.innerHTML += `
                        <div class="periodo-box">
                            <div class="periodo-titulo">${p}</div>
                            <img src="${d.icone}" class="icone-tempo" onerror="this.style.display='none'">
                            <div class="resumo">${d.resumo}</div>
                            <div class="temp-range"><span class="temp-min">${d.temp_min}°</span> | <span class="temp-max">${d.temp_max}°</span></div>
                        </div>`;
                }
            });

            if (pContainer.innerHTML === "") {
                 const d = diaInfo.dados;
                 pContainer.innerHTML = `
                    <div class="periodo-box">
                        <img src="${d.icone}" class="icone-tempo" onerror="this.style.display='none'">
                        <div class="resumo">${d.resumo || "Ver detalhes"}</div>
                        <div class="temp-range"><span class="temp-min">${d.temp_min}°</span> | <span class="temp-max">${d.temp_max}°</span></div>
                    </div>`;
            }
            card.appendChild(pContainer);
            divPrevisao.appendChild(card);
        });
    }
</script>
</body>
</html>